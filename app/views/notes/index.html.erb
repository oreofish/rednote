<%# encoding: utf-8 %>
<div class="well">
  <div id="note_publish">
    <div class="pull-right" id="input_hint">
    </div>

    <div class="row-fluid">
      <h4 class="span12">给工作添乐趣</h4>
    </div>
    <div class="row-fluid">
      <div class="span12">
        <%= form_for(@note, :html => { :multipart => true, :remote => true }) do |f| %>
        <%= f.text_area :summary, :rows => 4, "placeholder" => "写点什么吧", :class => "span12" %>
        <%= hidden_field_tag 'attachments', '', :id => "note_attachments" %>
        <a id="pickfiles" href="#">添加图片和文档</a>
        <button type="submit" class="btn btn-primary pull-right">
        发布
        </button>    
        <% end %>  <%# form_for end %>
      </div>

      <div class="span12">
        <div id="image_uploader">
          <div id="filelist" class="thumbnails">
          </div>
        </div>
      </div>

    </div>
  </div> <!-- note_publish -->

  <div id="flash_content">
    <a class="more label" href="#" data-toggle="collapse" data-target="#notifications">
      更多通知
      <b class="caret"></b>
    </a>
    <div id="notifications" class="flash collapse">
    </div>
  </div>

  <div id="notes_content">
    <ul class="list unstyled">
      <%= render "list" %>
    </ul>

    <!-- pager loading hinter -->
    <div class="inner" id="pager_loading">
    </div>

  </div> <!-- notes_content -->
</div>

<% session_key_name = Rails.application.config.session_options[:key] %>
<script type="text/javascript">
    var uploader = new plupload.Uploader({
      runtimes : 'html5,html4,gears,flash',
      browse_button : "pickfiles",
      container : "image_uploader",
      url : '/attachements',
      max_file_size : '50mb',
      //chunk_size : '1mb',
      unique_names : true,

      // Resize images on clientside if we can
      // resize : {width : 320, height : 240, quality : 90},

      multipart : true,
      multipart_params : {
          '_http_accept': 'application/javascript',
          'authenticity_token' : '<%= form_authenticity_token %>',
          '<%= session_key_name %>' : encodeURIComponent('<%= u cookies[session_key_name] %>')
      },

      // Specify what files to browse for
      filters : [
          {title : "Image files", extensions : "jpg,gif,png,jpeg"},
          {title : "Document files", extensions : "pdf,doc,txt"},
      ],

      // Flash settings
      flash_swf_url : '/plupload/js/plupload.flash.swf',
  });

    uploader.bind('Init', function(up, params) {
        // $('#filelist').html("<h2>Current runtime: " + params.runtime + "</h2>");
        });

    $('#uploadfiles').click(function(e) {
        uploader.start();
        e.preventDefault();
        });

    uploader.init();

    uploader.bind('FilesAdded', function(up, files) {
        $.each(files, function(i, file) {
          $('#filelist').append(
            '<li id="' + file.id + '" class="span4">' +
            file.name + ' (' + plupload.formatSize(file.size) + ') <b></b>' +
            '</li>');
          });

        up.refresh(); // Reposition Flash/Silverlight
        uploader.start();
        });

    uploader.bind('UploadProgress', function(up, file) {
        $('#' + file.id + " b").html(file.percent + "%");
        });

    uploader.bind('Error', function(up, err) {
        rednote.flashController && rednote.flashController.doFailure('添加失败', err.message);
        });

    uploader.bind('FileUploaded', function(up, file, resp) {
        var data, hidden_attach;
        var $file = $('#' + file.id);
        console.log(resp);
        if (resp.response.trim().length === 0)
            return;

        data = eval("(" + resp.response + ")");
        $file.html( '<div class="thumbnail"><img src="' + data.url + '"/></div>' + 
          '<div class="caption">' + file.name + '</div>' );

        hidden_attach = $('#new_note > #note_attachments').attr('value').trim();
        console.log(hidden_attach);
        if (hidden_attach.length) 
            hidden_attach += ",";
        hidden_attach += data.attachment_id;
        $('#new_note > #note_attachments').attr('value', hidden_attach);
        });

</script>

